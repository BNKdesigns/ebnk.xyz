<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>webchnl Tizen Debug</title>
    <link rel="icon" type="image/svg+xml" href="https://webchnl.com/assets/svg/webchnl_icon.svg">
    
    <script type="text/javascript" src="$WEBAPIS/webapis/webapis.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <style>
        body { background-color: #000; color: #fff; font-family: "Segoe UI", sans-serif; margin: 0; overflow: hidden; width: 100vw; height: 100vh; }
        #video-container { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; background: #000; z-index: 1; }
        #video-player { width: 100%; height: 100%; object-fit: contain; }
        
        /* DEBUG CONSOLE OVERLAY */
        #debug-console {
            position: absolute; top: 0; left: 0; width: 50%; height: 100%;
            background: rgba(0, 0, 0, 0.8); color: #0f0; font-family: monospace;
            font-size: 14px; padding: 20px; overflow-y: auto; z-index: 9999;
            pointer-events: none; display: none; /* Hidden by default, toggle with RED button */
            white-space: pre-wrap;
        }

        /* UI Elements */
        #osd-bar { position: absolute; top: 0; left: 0; width: 100%; height: 180px; padding: 0 60px; background: linear-gradient(180deg, rgba(0,0,0,0.95), rgba(0,0,0,0)); display: flex; align-items: center; opacity: 0; transition: opacity 0.4s; z-index: 20; }
        #ch-logo { height: 90px; width: 90px; object-fit: contain; margin-right: 30px; background: #000; border-radius: 18px; padding: 10px; }
        #ch-number { font-size: 1.8rem; font-weight: 700; color: #888; margin-bottom: 4px; }
        #ch-name { font-size: 2.5rem; font-weight: 600; }
        
        /* Guide */
        #guide-overlay { position: absolute; left: -480px; top: 0; width: 450px; height: 100%; background: rgba(30, 30, 30, 0.95); z-index: 30; transition: transform 0.3s; display: flex; flex-direction: column; }
        #guide-overlay.visible { transform: translateX(480px); }
        .guide-header { padding: 30px; border-bottom: 1px solid #444; }
        .guide-logo { height: 40px; }
        #channel-list { flex: 1; overflow-y: auto; padding: 10px; }
        .channel-item { padding: 15px; color: #aaa; font-size: 1.4rem; border-radius: 8px; }
        .channel-item.focused { background: rgba(244, 39, 40, 0.2); color: #fff; border: 2px solid #F42728; }
        
        /* Footer */
        #footer-controls { position: absolute; bottom: 40px; right: 50px; display: flex; gap: 15px; z-index: 20; opacity: 0.8; }
        .control-hint { background: rgba(0,0,0,0.7); padding: 10px 20px; border-radius: 50px; border: 1px solid #333; }
    </style>
</head>
<body>

    <div id="debug-console">=== DEBUG LOG STARTED ===<br>Press RED (A) to toggle log visibility.<br></div>

    <div id="app-container">
        <div id="video-container"><video id="video-player"></video></div>

        <div id="osd-bar">
            <img id="ch-logo" src="" onerror="this.style.opacity='0'">
            <div class="channel-info">
                <span id="ch-number">000</span>
                <span id="ch-name">Initializing...</span>
            </div>
        </div>

        <div id="guide-overlay">
            <div class="guide-header"><img src="https://webchnl.com/assets/svg/webchnl_full.svg" class="guide-logo"></div>
            <div id="channel-list"></div>
        </div>

        <div id="footer-controls">
            <div class="control-hint">OK: Guide</div>
            <div class="control-hint">▲▼: Channel</div>
            <div class="control-hint">RED: Log</div>
        </div>
    </div>

    <script>
        // --- DEBUGGER UTILITY ---
        function log(msg, isError = false) {
            const debugEl = document.getElementById('debug-console');
            const line = document.createElement('div');
            line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            if (isError) line.style.color = '#f55';
            debugEl.appendChild(line);
            debugEl.scrollTop = debugEl.scrollHeight;
            console.log(msg);
        }
        window.onerror = function(msg, source, lineno) {
            log(`CRASH: ${msg} @ line ${lineno}`, true);
        };

        // --- CONFIG ---
        const API_URL = "https://webchnl.com/api/channels.php";
        
        // FALLBACK DATA (Used if API fails)
        const FALLBACK_CHANNELS = [
            { id: "001", name: "Backup Channel 1", stream: "https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8", logo: "" },
            { id: "002", name: "Backup Channel 2", stream: "https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8", logo: "" }
        ];
        
        let CHANNELS = [];
        let currentIndex = 0;
        let isGuideOpen = false;
        let hls = null;
        let osdTimeout;
        let debugVisible = false;

        const els = {
            video: document.getElementById('video-player'),
            osd: document.getElementById('osd-bar'),
            chNum: document.getElementById('ch-number'),
            chName: document.getElementById('ch-name'),
            chLogo: document.getElementById('ch-logo'),
            guide: document.getElementById('guide-overlay'),
            list: document.getElementById('channel-list'),
            debug: document.getElementById('debug-console')
        };

        window.onload = () => {
            log("App Loaded. Initializing...");
            initTizen();
            fetchChannels();
            
            // Force focus to body to ensure keys work
            document.body.focus();
        };

        function initTizen() {
            if (typeof tizen !== 'undefined') {
                try {
                    tizen.tvinputdevice.registerKey('10009'); // Back
                    tizen.tvinputdevice.registerKey('ChannelUp');
                    tizen.tvinputdevice.registerKey('ChannelDown');
                    tizen.tvinputdevice.registerKey('MediaPlayPause');
                    tizen.tvinputdevice.registerKey('ColorF0Red'); // For Debug Toggle
                    log("Tizen Keys Registered");
                } catch (e) {
                    log("Error registering Tizen keys: " + e.message, true);
                }
            } else {
                log("Not running on Tizen hardware.");
            }
        }

        function fetchChannels() {
            log("Fetching channels from API...");
            
            // Set a timeout to switch to fallback if API hangs
            const timeout = setTimeout(() => {
                if (CHANNELS.length === 0) {
                    log("API timed out. Using fallback data.", true);
                    useFallbackData();
                }
            }, 5000);

            fetch(API_URL)
                .then(res => {
                    if (!res.ok) throw new Error("HTTP " + res.status);
                    return res.json();
                })
                .then(data => {
                    clearTimeout(timeout);
                    log(`API Success. Found ${data.length} channels.`);
                    
                    CHANNELS = data.map((c, i) => ({
                        id: (i + 1).toString().padStart(3, '0'),
                        name: c.name || "Unknown",
                        logo: c.logo_url || "",
                        stream: c.stream_url || ""
                    }));

                    if (CHANNELS.length > 0) {
                        buildGuide();
                        loadChannel(0);
                    } else {
                        log("API returned 0 channels.", true);
                        useFallbackData();
                    }
                })
                .catch(err => {
                    clearTimeout(timeout);
                    log("Fetch Error: " + err.message, true);
                    useFallbackData();
                });
        }

        function useFallbackData() {
            log("Loading Backup Channels...");
            CHANNELS = FALLBACK_CHANNELS;
            buildGuide();
            loadChannel(0);
        }

        function buildGuide() {
            els.list.innerHTML = '';
            CHANNELS.forEach((ch, idx) => {
                const item = document.createElement('div');
                item.className = 'channel-item';
                item.innerHTML = `<span class="num">${ch.id}</span> <span class="name">${ch.name}</span>`;
                item.dataset.index = idx;
                els.list.appendChild(item);
            });
        }

        function playStream(url) {
            log("Playing: " + url);
            const video = els.video;

            if (Hls.isSupported()) {
                if (hls) hls.destroy();
                hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    video.play().catch(e => log("Play blocked: " + e.message, true));
                });
                hls.on(Hls.Events.ERROR, (event, data) => {
                    if (data.fatal) {
                        log("HLS Fatal Error: " + data.type, true);
                        if (data.type === Hls.ErrorTypes.NETWORK_ERROR) hls.startLoad();
                        else hls.destroy();
                    }
                });
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = url;
                video.addEventListener('loadedmetadata', () => {
                    video.play().catch(e => log("Native Play blocked: " + e.message, true));
                });
            } else {
                log("HLS not supported on this device.", true);
            }
        }

        function loadChannel(index) {
            if (index < 0) index = CHANNELS.length - 1;
            if (index >= CHANNELS.length) index = 0;
            
            currentIndex = index;
            const ch = CHANNELS[currentIndex];

            if (ch.stream) playStream(ch.stream);
            else log("Channel has no stream URL", true);

            els.chNum.innerText = ch.id;
            els.chName.innerText = ch.name;
            
            if (ch.logo) {
                els.chLogo.src = ch.logo;
                els.chLogo.style.opacity = '1';
                els.chLogo.style.display = 'block';
            } else {
                els.chLogo.style.opacity = '0';
            }

            showOSD();
            if (isGuideOpen) updateGuideFocus();
        }

        function showOSD() {
            els.osd.style.opacity = '1';
            clearTimeout(osdTimeout);
            osdTimeout = setTimeout(() => {
                if (!isGuideOpen) els.osd.style.opacity = '0';
            }, 5000);
        }

        function updateGuideFocus() {
            document.querySelectorAll('.channel-item').forEach(el => el.classList.remove('focused'));
            if (els.list.children[currentIndex]) {
                els.list.children[currentIndex].classList.add('focused');
                els.list.children[currentIndex].scrollIntoView({ block: 'center' });
            }
        }

        // --- KEY HANDLER ---
        document.addEventListener('keydown', (e) => {
            const k = e.keyCode;
            log("Key Pressed: " + k); // Log key to screen

            if (k === 403 || k === 82) { // RED Button or 'R' on keyboard
                debugVisible = !debugVisible;
                els.debug.style.display = debugVisible ? 'block' : 'none';
                return;
            }

            if (CHANNELS.length === 0) {
                log("Ignored key: No channels loaded.", true);
                return;
            }

            const IS_UP = (k === 38 || k === 29460 || k === 427);
            const IS_DOWN = (k === 40 || k === 29461 || k === 428);
            const ENTER = (k === 13);
            const BACK = (k === 10009 || k === 461 || k === 8);

            if (isGuideOpen) {
                if (IS_UP) {
                    currentIndex--; 
                    if (currentIndex < 0) currentIndex = CHANNELS.length - 1;updateGuideFocus();
                } else if (IS_DOWN) {
                    currentIndex++;
                    if (currentIndex >= CHANNELS.length) currentIndex = 0;
                    updateGuideFocus();
                } else if (ENTER || k === 39) { // Enter or Right
                    loadChannel(currentIndex);
                    isGuideOpen = false;
                    els.guide.classList.remove('visible');
                } else if (BACK || k === 37) { // Back or Left
                    isGuideOpen = false;
                    els.guide.classList.remove('visible');
                }
            } else {
                if (IS_UP) loadChannel(currentIndex + 1);
                else if (IS_DOWN) loadChannel(currentIndex - 1);
                else if (ENTER || k === 39 || k === 37) {
                    isGuideOpen = true;
                    els.guide.classList.add('visible');
                    updateGuideFocus();
                } else if (BACK) {
                    // Try to exit app
                    try { tizen.application.getCurrentApplication().exit(); } catch(e) {}
                }
            }
        });
    </script>
</body>
</html>
